name: CD → Production

on:
  workflow_dispatch:
  push:
    branches: [main]

concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  # Production always deploys all services for safety.
  # Only migrations are conditional — they run when drizzle files change.
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      run-migrations: ${{ steps.check.outputs.run-migrations }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            migrations:
              - 'packages/db/drizzle/**'

      - name: Check migration need
        id: check
        run: |
          echo "run-migrations=${{ steps.changes.outputs.migrations }}" >> $GITHUB_OUTPUT

  deploy:
    needs: detect-changes
    uses: ./.github/workflows/deploy.yml
    with:
      environment: production
      api-app: valet-api
      worker-app: valet-worker
      web-app: valet-web
      api-url: https://valet-api.fly.dev
      google-client-id: "108153440133-8oorgsj5m7u67fg68bulpr1akrs6ttet.apps.googleusercontent.com"
      deploy-api: true
      deploy-worker: true
      deploy-web: true
      run-migrations: ${{ needs.detect-changes.outputs.run-migrations == 'true' }}
    secrets:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
      DATABASE_DIRECT_URL: ${{ secrets.DATABASE_DIRECT_URL }}
