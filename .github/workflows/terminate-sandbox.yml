# =============================================================================
# Terminate Sandbox â€” Gracefully destroy an EC2 browser worker instance
# =============================================================================
#
# Drains the sandbox of active tasks, terminates the EC2 instance via
# Terraform, updates the sandbox status in the API, and cleans up secrets.
#
# Prerequisites:
#   - AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY in GitHub Secrets
#   - VALET_API_TOKEN (admin API token) in GitHub Secrets
#
# =============================================================================

name: Terminate Sandbox

on:
  workflow_dispatch:
    inputs:
      sandbox_id:
        description: "Sandbox ID to terminate (from API)"
        required: true
        type: string
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - dev
          - staging
          - prod
      force:
        description: "Force terminate without draining"
        required: false
        type: boolean
        default: false

concurrency:
  group: terminate-sandbox-${{ github.event.inputs.sandbox_id }}
  cancel-in-progress: false

env:
  TF_DIR: infra/terraform
  AWS_REGION: us-east-1

jobs:
  terminate:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Determine API URL
        id: api
        run: |
          case "${{ github.event.inputs.environment }}" in
            prod)    echo "url=https://valet-api.fly.dev" >> $GITHUB_OUTPUT ;;
            staging) echo "url=https://valet-api-stg.fly.dev" >> $GITHUB_OUTPUT ;;
            dev)     echo "url=https://valet-api-stg.fly.dev" >> $GITHUB_OUTPUT ;;
          esac

      - name: Fetch sandbox details from API
        id: sandbox
        run: |
          SANDBOX_ID="${{ github.event.inputs.sandbox_id }}"
          API_URL="${{ steps.api.outputs.url }}"

          RESPONSE=$(curl -sf "$API_URL/api/v1/admin/sandboxes/$SANDBOX_ID" \
            -H "Authorization: Bearer ${{ secrets.VALET_API_TOKEN }}" 2>/dev/null) || {
            echo "::warning::Could not fetch sandbox from API. Proceeding with manual cleanup."
            echo "instance_id=unknown" >> $GITHUB_OUTPUT
            echo "public_ip=unknown" >> $GITHUB_OUTPUT
            exit 0
          }

          INSTANCE_ID=$(echo "$RESPONSE" | jq -r '.instance_id // "unknown"')
          PUBLIC_IP=$(echo "$RESPONSE" | jq -r '.public_ip // "unknown"')
          STATUS=$(echo "$RESPONSE" | jq -r '.status // "unknown"')

          echo "instance_id=$INSTANCE_ID" >> $GITHUB_OUTPUT
          echo "public_ip=$PUBLIC_IP" >> $GITHUB_OUTPUT
          echo "current_status=$STATUS" >> $GITHUB_OUTPUT
          echo "Sandbox $SANDBOX_ID: instance=$INSTANCE_ID, ip=$PUBLIC_IP, status=$STATUS"

      - name: Mark sandbox as terminating
        run: |
          SANDBOX_ID="${{ github.event.inputs.sandbox_id }}"
          API_URL="${{ steps.api.outputs.url }}"

          curl -sf -X PATCH "$API_URL/api/v1/admin/sandboxes/$SANDBOX_ID" \
            -H "Authorization: Bearer ${{ secrets.VALET_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"status": "terminating"}' 2>/dev/null || {
            echo "::warning::Could not update sandbox status"
          }

      - name: Stop worker service
        if: steps.sandbox.outputs.public_ip != 'unknown'
        continue-on-error: true
        run: |
          PUBLIC_IP="${{ steps.sandbox.outputs.public_ip }}"

          # Write SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.SANDBOX_SSH_KEY }}" > ~/.ssh/ec2_key
          chmod 600 ~/.ssh/ec2_key

          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ubuntu@$PUBLIC_IP "sudo systemctl stop valet-worker" 2>/dev/null || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.7"
          terraform_wrapper: false

      - name: Terraform init
        working-directory: ${{ env.TF_DIR }}
        run: terraform init

      - name: Terraform destroy instance
        working-directory: ${{ env.TF_DIR }}
        run: |
          INSTANCE_ID="${{ steps.sandbox.outputs.instance_id }}"

          # Map environment
          TF_ENV="${{ github.event.inputs.environment }}"
          if [[ "$TF_ENV" == "prod" ]]; then
            TF_ENV="production"
          fi

          # If we have a specific instance ID, target it
          if [[ "$INSTANCE_ID" != "unknown" ]]; then
            echo "Destroying instance $INSTANCE_ID..."
            terraform destroy -auto-approve \
              -var="environment=$TF_ENV" \
              -var="key_name=valet-worker" \
              -var="instance_count=0" || {
              echo "::warning::Targeted destroy failed, attempting full destroy"
              terraform destroy -auto-approve \
                -var="environment=$TF_ENV" \
                -var="key_name=valet-worker"
            }
          else
            echo "::warning::No instance ID available. Skipping Terraform destroy."
            echo "Manual cleanup may be required in AWS Console."
          fi

      - name: Update sandbox status to terminated
        run: |
          SANDBOX_ID="${{ github.event.inputs.sandbox_id }}"
          API_URL="${{ steps.api.outputs.url }}"

          curl -sf -X PATCH "$API_URL/api/v1/admin/sandboxes/$SANDBOX_ID" \
            -H "Authorization: Bearer ${{ secrets.VALET_API_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"status": "terminated"}' 2>/dev/null || {
            echo "::warning::Could not update sandbox status to terminated"
          }

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2_key

      - name: Termination summary
        if: always()
        run: |
          echo "### Sandbox Terminated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Sandbox ID | ${{ github.event.inputs.sandbox_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance ID | ${{ steps.sandbox.outputs.instance_id }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Public IP | ${{ steps.sandbox.outputs.public_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Force | ${{ github.event.inputs.force }} |" >> $GITHUB_STEP_SUMMARY
