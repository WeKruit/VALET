# =============================================================================
# Secrets Sync — Push .env to All EC2 Sandboxes
# =============================================================================
#
# Manually triggered workflow that synchronizes environment variables
# across all sandbox instances in a given environment.
#
# Usage:
#   1. Go to Actions > "Secrets Sync → EC2 Sandboxes" > Run workflow
#   2. Select the target environment (staging or production)
#   3. Optionally specify specific IPs (comma-separated) or leave empty for all
#
# The workflow reads the SANDBOX_WORKER_ENV secret (the full .env file contents)
# and writes it to /opt/valet/.env on each sandbox, then restarts the worker.
#
# === Required GitHub Secrets ===
#
# Set these in GitHub Settings > Environments > staging / production:
#
#   SANDBOX_IPS          JSON array of sandbox IPs (e.g. ["34.197.248.80"])
#   SANDBOX_SSH_KEY      SSH private key for accessing sandboxes
#   SANDBOX_WORKER_ENV   Full .env file contents for the worker service.
#                        Example:
#                          NODE_ENV=production
#                          HATCHET_CLIENT_TOKEN=...
#                          DATABASE_URL=postgresql://...
#                          REDIS_URL=rediss://...
#                          ...
#
# For legacy single-instance setups, EC2_IP_STG/EC2_IP_PROD and
# EC2_SSH_KEY_STG/EC2_SSH_KEY_PROD are also supported as fallbacks.
# =============================================================================

name: Secrets Sync → EC2 Sandboxes

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        default: staging
        type: choice
        options:
          - staging
          - production
      target_ips:
        description: >
          Comma-separated IPs to sync (e.g. "34.197.248.80,35.123.45.67").
          Leave empty to sync all sandboxes in the environment.
        required: false
        type: string

concurrency:
  group: secrets-sync-${{ github.event.inputs.environment }}
  cancel-in-progress: false

jobs:
  resolve-targets:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    outputs:
      sandbox_ips: ${{ steps.matrix.outputs.sandbox_ips }}
    steps:
      - name: Build target IP list
        id: matrix
        run: |
          # 1. Check for workflow_dispatch target_ips input
          if [[ -n "${{ github.event.inputs.target_ips }}" ]]; then
            IPS=$(echo '${{ github.event.inputs.target_ips }}' | tr ',' '\n' | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//' | jq -R . | jq -s .)
            echo "sandbox_ips=$IPS" >> $GITHUB_OUTPUT
            echo "Using specified target IPs: $IPS"
            exit 0
          fi

          # 2. Try SANDBOX_IPS from environment secrets
          SANDBOX_IPS_JSON='${{ secrets.SANDBOX_IPS }}'
          if [[ -n "$SANDBOX_IPS_JSON" && "$SANDBOX_IPS_JSON" != "null" ]]; then
            echo "sandbox_ips=$SANDBOX_IPS_JSON" >> $GITHUB_OUTPUT
            echo "Using SANDBOX_IPS secret: $SANDBOX_IPS_JSON"
            exit 0
          fi

          # 3. Fallback to legacy secrets
          if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
            LEGACY_IP='${{ secrets.EC2_IP_PROD }}'
          else
            LEGACY_IP='${{ secrets.EC2_IP_STG }}'
          fi

          if [[ -n "$LEGACY_IP" ]]; then
            echo "sandbox_ips=[\"$LEGACY_IP\"]" >> $GITHUB_OUTPUT
            echo "Using legacy IP: $LEGACY_IP"
            exit 0
          fi

          echo "::error::No sandbox IPs configured."
          exit 1

  sync:
    needs: resolve-targets
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}

    strategy:
      matrix:
        instance_ip: ${{ fromJson(needs.resolve-targets.outputs.sandbox_ips) }}
      fail-fast: false
      max-parallel: 5

    concurrency:
      group: secrets-sync-instance-${{ matrix.instance_ip }}
      cancel-in-progress: false

    steps:
      - name: Validate secrets
        run: |
          if [[ -z "${{ secrets.SANDBOX_WORKER_ENV }}" ]]; then
            echo "::error::SANDBOX_WORKER_ENV secret is not set for environment '${{ github.event.inputs.environment }}'."
            echo "Set it in GitHub Settings > Environments > ${{ github.event.inputs.environment }} > Secrets."
            exit 1
          fi

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh

          echo "${{ secrets.SANDBOX_SSH_KEY }}" > ~/.ssh/ec2_key

          # Fallback to legacy keys
          if [[ ! -s ~/.ssh/ec2_key ]]; then
            if [[ "${{ github.event.inputs.environment }}" == "production" ]]; then
              echo "${{ secrets.EC2_SSH_KEY_PROD }}" > ~/.ssh/ec2_key
            else
              echo "${{ secrets.EC2_SSH_KEY_STG }}" > ~/.ssh/ec2_key
            fi
          fi

          chmod 600 ~/.ssh/ec2_key
          ssh-keyscan -H ${{ matrix.instance_ip }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Test SSH connectivity
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
            ubuntu@${{ matrix.instance_ip }} "echo 'SSH OK'" || {
            echo "::error::Cannot connect to ${{ matrix.instance_ip }}"
            exit 1
          }

      - name: Write .env to sandbox
        run: |
          # Write the env file contents via SSH stdin
          echo '${{ secrets.SANDBOX_WORKER_ENV }}' | \
            ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
              ubuntu@${{ matrix.instance_ip }} \
              "sudo tee /opt/valet/.env > /dev/null && sudo chmod 600 /opt/valet/.env && (id valet &>/dev/null && sudo chown valet:valet /opt/valet/.env || true)"

          echo "Env file written to ${{ matrix.instance_ip }}:/opt/valet/.env"

      - name: Restart valet-worker service
        run: |
          ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ubuntu@${{ matrix.instance_ip }} \
            "sudo systemctl restart valet-worker"

          echo "Waiting for service to stabilize (5s)..."
          sleep 5

      - name: Verify service health
        run: |
          SERVICE_STATUS=$(ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
            ubuntu@${{ matrix.instance_ip }} \
            "sudo systemctl is-active valet-worker 2>/dev/null" 2>/dev/null || echo "inactive")

          if [[ "$SERVICE_STATUS" == "active" ]]; then
            echo "Service is running on ${{ matrix.instance_ip }}"
          else
            echo "::warning::Service not active on ${{ matrix.instance_ip }} (status: $SERVICE_STATUS)"
            ssh -i ~/.ssh/ec2_key -o StrictHostKeyChecking=no \
              ubuntu@${{ matrix.instance_ip }} \
              "sudo journalctl -u valet-worker -n 20 --no-pager" 2>/dev/null || true
            exit 1
          fi

      - name: Cleanup SSH key
        if: always()
        run: rm -f ~/.ssh/ec2_key

      - name: Sync summary
        if: always()
        run: |
          echo "### Secrets Sync — ${{ matrix.instance_ip }}" >> $GITHUB_STEP_SUMMARY
          echo "| Field | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Environment | ${{ github.event.inputs.environment }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Instance | ${{ matrix.instance_ip }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Result | ${{ job.status }} |" >> $GITHUB_STEP_SUMMARY
