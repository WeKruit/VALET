name: CD → Staging

on:
  push:
    branches: [staging]
  workflow_dispatch:
    inputs:
      deploy-all:
        description: "Force deploy all services (bypass change detection)"
        required: false
        type: boolean
        default: false

concurrency:
  group: deploy-staging
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      deploy-api: ${{ steps.targets.outputs.deploy-api }}
      deploy-worker: ${{ steps.targets.outputs.deploy-worker }}
      deploy-web: ${{ steps.targets.outputs.deploy-web }}
      any-deploy: ${{ steps.targets.outputs.any-deploy }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: dorny/paths-filter@v3
        id: changes
        with:
          # Compare against the previous staging commit (not default shallow-clone behavior)
          base: ${{ github.event.before }}
          filters: |
            shared:
              - 'packages/shared/**'
            contracts:
              - 'packages/contracts/**'
            db:
              - 'packages/db/**'
            llm:
              - 'packages/llm/**'
            ui:
              - 'packages/ui/**'
            api:
              - 'apps/api/**'
            worker:
              - 'apps/worker/**'
            web:
              - 'apps/web/**'
            infra:
              - 'fly/**'
              - 'pnpm-lock.yaml'
              - 'turbo.json'
              - 'tsconfig.json'

      - name: Determine deploy targets
        id: targets
        run: |
          # Manual dispatch with deploy-all overrides change detection
          if [[ "${{ inputs.deploy-all }}" == "true" ]]; then
            echo "deploy-api=true" >> $GITHUB_OUTPUT
            echo "deploy-worker=true" >> $GITHUB_OUTPUT
            echo "deploy-web=true" >> $GITHUB_OUTPUT
            echo "any-deploy=true" >> $GITHUB_OUTPUT
            echo "Manual deploy-all: deploying all services"
            exit 0
          fi

          # Staging is our integration branch — if paths-filter detected NO changes
          # (e.g. due to main:staging push), deploy everything to be safe
          CHANGES_DETECTED=false

          # API depends on: shared, contracts, db, llm
          if [[ "${{ steps.changes.outputs.api }}" == "true" \
             || "${{ steps.changes.outputs.shared }}" == "true" \
             || "${{ steps.changes.outputs.contracts }}" == "true" \
             || "${{ steps.changes.outputs.db }}" == "true" \
             || "${{ steps.changes.outputs.llm }}" == "true" \
             || "${{ steps.changes.outputs.infra }}" == "true" ]]; then
            DEPLOY_API=true
            CHANGES_DETECTED=true
          else
            DEPLOY_API=false
          fi

          # Worker depends on: shared, contracts, db, llm
          if [[ "${{ steps.changes.outputs.worker }}" == "true" \
             || "${{ steps.changes.outputs.shared }}" == "true" \
             || "${{ steps.changes.outputs.contracts }}" == "true" \
             || "${{ steps.changes.outputs.db }}" == "true" \
             || "${{ steps.changes.outputs.llm }}" == "true" \
             || "${{ steps.changes.outputs.infra }}" == "true" ]]; then
            DEPLOY_WORKER=true
            CHANGES_DETECTED=true
          else
            DEPLOY_WORKER=false
          fi

          # Web depends on: shared, contracts, ui
          if [[ "${{ steps.changes.outputs.web }}" == "true" \
             || "${{ steps.changes.outputs.shared }}" == "true" \
             || "${{ steps.changes.outputs.contracts }}" == "true" \
             || "${{ steps.changes.outputs.ui }}" == "true" \
             || "${{ steps.changes.outputs.infra }}" == "true" ]]; then
            DEPLOY_WEB=true
            CHANGES_DETECTED=true
          else
            DEPLOY_WEB=false
          fi

          # Safety net: if paths-filter detected nothing, deploy everything.
          # This handles cross-branch pushes (git push origin main:staging)
          # where dorny/paths-filter can't resolve the diff properly.
          if [[ "$CHANGES_DETECTED" == "false" ]]; then
            echo "⚠️ No path changes detected — deploying all as safety fallback"
            DEPLOY_API=true
            DEPLOY_WORKER=true
            DEPLOY_WEB=true
          fi

          echo "deploy-api=$DEPLOY_API" >> $GITHUB_OUTPUT
          echo "deploy-worker=$DEPLOY_WORKER" >> $GITHUB_OUTPUT
          echo "deploy-web=$DEPLOY_WEB" >> $GITHUB_OUTPUT
          echo "any-deploy=true" >> $GITHUB_OUTPUT

          echo "### Deploy Targets" >> $GITHUB_STEP_SUMMARY
          echo "| Target | Deploy? |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|---------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | $DEPLOY_API |" >> $GITHUB_STEP_SUMMARY
          echo "| Worker | $DEPLOY_WORKER |" >> $GITHUB_STEP_SUMMARY
          echo "| Web | $DEPLOY_WEB |" >> $GITHUB_STEP_SUMMARY
          echo "Note: DB migrations run automatically via Fly.io release_command during API deploy" >> $GITHUB_STEP_SUMMARY

  deploy:
    needs: detect-changes
    if: needs.detect-changes.outputs.any-deploy == 'true'
    uses: ./.github/workflows/deploy.yml
    with:
      environment: staging
      api-app: valet-api-stg
      worker-app: valet-worker-stg
      web-app: valet-web-stg
      api-url: https://valet-api-stg.fly.dev
      google-client-id: "108153440133-8oorgsj5m7u67fg68bulpr1akrs6ttet.apps.googleusercontent.com"
      deploy-api: ${{ needs.detect-changes.outputs.deploy-api == 'true' }}
      deploy-worker: ${{ needs.detect-changes.outputs.deploy-worker == 'true' }}
      deploy-web: ${{ needs.detect-changes.outputs.deploy-web == 'true' }}
    secrets:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
